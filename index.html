<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Civisme</title>
  <!-- Markdown-it and its footnote plugin -->
  <script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/markdown-it-footnote/dist/markdown-it-footnote.min.js"></script>
  <!-- Link to external CSS -->
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <button class="hamburger" id="hamburger">☰ Menu</button>
  <button id="scrollTopBtn" title="Scroll to top">↑ Top</button>
  <div class="container">
    <!-- Left Sidebar -->
    <aside class="sidebar" id="sidebar">
      <!-- Markdown Files List -->
      <section id="file-section">
        <h2>Markdown Files</h2>
        <ul id="file-list"></ul>
      </section>
      <!-- Collapsible TOC Section -->
      <section id="toc-section">
        <div class="toc-header" id="toc-header">Table of Contents ▼</div>
        <div class="toc-content" id="toc-content">
          <!-- TOC will be dynamically generated here -->
        </div>
      </section>
    </aside>

    <!-- Main Content Area -->
    <main class="main-content" id="content">
      <p>Select a Markdown file from the sidebar to display its content.</p>
    </main>
  </div>

  <script>
    // GitHub repo details
    const repoOwner = "exotriks";
    const repoName = "civisme";
    const branch = "master"; // Change to "main" if needed
    const folderPath = "books/md"; // Your Markdown folder
    const fileList = document.getElementById("file-list");
    const contentDiv = document.getElementById("content");

    // Base URLs for images and download files
    const coversBaseUrl = `https://raw.githubusercontent.com/${repoOwner}/${repoName}/${branch}/images/covers/recto/`;
    const txtBaseUrl = `https://raw.githubusercontent.com/${repoOwner}/${repoName}/${branch}/books/txt/`;
    const pdfBaseUrl = `https://raw.githubusercontent.com/${repoOwner}/${repoName}/${branch}/books/pdf/`;
    const mdBaseUrl  = `https://raw.githubusercontent.com/${repoOwner}/${repoName}/${branch}/books/md/`;

    // Initialize markdown-it with footnote support
    const md = window.markdownit({ html: true }).use(window.markdownitFootnote);

    // Hamburger menu toggling
    const hamburger = document.getElementById("hamburger");
    const sidebar = document.getElementById("sidebar");

    hamburger.addEventListener("click", () => {
      sidebar.classList.toggle("show");
    });

    // Scroll to Top button
    const scrollTopBtn = document.getElementById("scrollTopBtn");

    // When the user scrolls down 100px from the top, show the button
    window.onscroll = function () {
      if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) {
        scrollTopBtn.style.display = "block";
      } else {
        scrollTopBtn.style.display = "none";
      }
    };

    scrollTopBtn.addEventListener("click", () => {
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    // Fetch Markdown files from GitHub repo
    async function fetchMarkdownFiles() {
      const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${folderPath}`;
      try {
        const response = await fetch(apiUrl);
        const files = await response.json();
        files.forEach(file => {
          if (file.name.endsWith(".md")) {
            const li = document.createElement("li");
            const link = document.createElement("a");
            link.href = "#";
            link.textContent = file.name;
            link.addEventListener("click", (e) => {
              e.preventDefault();
              loadMarkdown(file.download_url, file.name);
              // On mobile, hide the sidebar after selection
              if (window.innerWidth <= 768) {
                sidebar.classList.remove("show");
              }
            });
            li.appendChild(link);
            fileList.appendChild(li);
          }
        });
      } catch (error) {
        console.error("Error fetching markdown files:", error);
      }
    }

    // Load Markdown content, render it, display cover image and download buttons, and generate TOC
    async function loadMarkdown(url, fileName) {
      try {
        const response = await fetch(url);
        const markdown = await response.text();
        const renderedHTML = md.render(markdown);

        // Clear the content div
        contentDiv.innerHTML = "";

        // Determine the base file name without extension.
        const baseName = fileName.replace(".md", "");

        // Construct the cover image file name using the naming convention
        const coverImageName = `couverture_${baseName}_recto_648x960.jpg`;
        const coverImageUrl = coversBaseUrl + coverImageName;

        // Create a container for the cover image and download buttons
        const coverContainer = document.createElement("div");
        coverContainer.className = "cover-container";

        // Create and append the cover image
        const coverImg = document.createElement("img");
        coverImg.src = coverImageUrl;
        coverImg.alt = baseName + " cover";
        coverImg.className = "cover-image";
        coverContainer.appendChild(coverImg);

        // Create a container for download buttons
        const downloadContainer = document.createElement("div");
        downloadContainer.className = "download-buttons";

        // Create buttons for TXT, PDF, and MD downloads
        const btnTxt = document.createElement("a");
        btnTxt.href = txtBaseUrl + baseName + ".txt";
        btnTxt.textContent = "Download TXT";
        btnTxt.className = "download-btn";
        btnTxt.download = ""; // triggers automatic download
        downloadContainer.appendChild(btnTxt);

        const btnPdf = document.createElement("a");
        btnPdf.href = pdfBaseUrl + baseName + ".pdf";
        btnPdf.textContent = "Download PDF";
        btnPdf.className = "download-btn";
        btnPdf.download = "";
        downloadContainer.appendChild(btnPdf);

        const btnMd = document.createElement("a");
        btnMd.href = mdBaseUrl + baseName + ".md";
        btnMd.textContent = "Download MD";
        btnMd.className = "download-btn";
        btnMd.download = "";
        downloadContainer.appendChild(btnMd);

        // Append download buttons under the cover image
        coverContainer.appendChild(downloadContainer);

        // Append the cover container to the content div
        contentDiv.appendChild(coverContainer);

        // Append the rendered Markdown content
        const markdownContainer = document.createElement("div");
        markdownContainer.className = "markdown-content";
        markdownContainer.innerHTML = renderedHTML;
        contentDiv.appendChild(markdownContainer);

        // Generate the Table of Contents based on headings in the markdown content
        generateTOC();
      } catch (error) {
        console.error("Error loading markdown content:", error);
      }
    }

    // Generate Table of Contents from the headings in the content
    function generateTOC() {
      const tocContent = document.getElementById("toc-content");
      tocContent.innerHTML = ""; // clear previous TOC
      const headings = contentDiv.querySelectorAll(".markdown-content h1, .markdown-content h2, .markdown-content h3, .markdown-content h4, .markdown-content h5, .markdown-content h6");
      if (headings.length === 0) {
        tocContent.innerHTML = "<p>No headings found.</p>";
        return;
      }
      
      const tocList = document.createElement("ul");

      headings.forEach(heading => {
        // Ensure each heading has an id for linking
        if (!heading.id) {
          heading.id = heading.textContent.trim().toLowerCase().replace(/\s+/g, '-');
        }
        const li = document.createElement("li");
        // Indent based on heading level (optional)
        li.style.marginLeft = (parseInt(heading.tagName.substring(1)) - 1) * 10 + "px";
        const a = document.createElement("a");
        a.href = "#" + heading.id;
        a.textContent = heading.textContent;
        li.appendChild(a);
        tocList.appendChild(li);
      });
      tocContent.appendChild(tocList);
    }

    // Toggle TOC collapse/expand
    const tocHeader = document.getElementById("toc-header");
    tocHeader.addEventListener("click", () => {
      const tocContent = document.getElementById("toc-content");
      if (tocContent.style.display === "block") {
        tocContent.style.display = "none";
        tocHeader.textContent = "Table of Contents ▼";
      } else {
        tocContent.style.display = "block";
        tocHeader.textContent = "Table of Contents ▲";
      }
    });

    // Fetch file list on page load
    fetchMarkdownFiles();
  </script>
</body>
</html>
